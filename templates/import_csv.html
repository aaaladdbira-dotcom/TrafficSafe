{% extends "base_private.html" %}

{% block head_extra %}
<style>
/* Import Page Styling */
.import-container {
  max-width: 700px;
  margin: 0 auto;
  padding: 20px 0;
}

.import-header {
  text-align: center;
  margin-bottom: 40px;
}

.import-header-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
  border-radius: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 24px;
  color: #3b82f6;
}

.import-header h2 {
  font-size: 28px;
  font-weight: 700;
  color: var(--ui-text);
  margin: 0 0 8px;
}

.import-header p {
  font-size: 14px;
  color: var(--ui-muted);
  margin: 0;
}

/* Upload Zone */
.upload-zone {
  background: var(--ui-surface);
  border: 2px dashed var(--ui-border);
  border-radius: 20px;
  padding: 48px 32px;
  text-align: center;
  transition: all 250ms ease;
  cursor: pointer;
  position: relative;
}

.upload-zone:hover,
.upload-zone.drag-over {
  border-color: var(--ui-primary);
  background: rgba(59, 130, 246, 0.04);
}

.upload-zone-icon {
  width: 64px;
  height: 64px;
  background: var(--ui-bg);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  color: var(--ui-muted);
  transition: all 250ms ease;
}

.upload-zone:hover .upload-zone-icon {
  color: var(--ui-primary);
  transform: translateY(-4px);
}

.upload-zone-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--ui-text);
  margin-bottom: 8px;
}

.upload-zone-desc {
  font-size: 13px;
  color: var(--ui-muted);
  margin-bottom: 20px;
}

.upload-zone input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.upload-zone-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--ui-primary) 0%, var(--brand-600) 100%);
  color: white;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  pointer-events: none;
}

/* File selected state */
.file-selected {
  background: var(--ui-surface);
  border: 1px solid var(--ui-border);
  border-radius: 14px;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 20px;
}

.file-selected-icon {
  width: 48px;
  height: 48px;
  background: rgba(34, 197, 94, 0.1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #22c55e;
}

.file-selected-info {
  flex: 1;
}

.file-selected-name {
  font-weight: 600;
  color: var(--ui-text);
  margin-bottom: 2px;
}

.file-selected-size {
  font-size: 12px;
  color: var(--ui-muted);
}

.file-selected-remove {
  padding: 8px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--ui-muted);
  cursor: pointer;
  transition: all 150ms ease;
}

.file-selected-remove:hover {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

/* Preview table */
#csv-preview {
  margin-top: 32px;
}

#csv-preview h5 {
  font-size: 14px;
  font-weight: 600;
  color: var(--ui-text);
  margin-bottom: 16px;
}

#csv-preview-table {
  font-size: 13px;
  border-radius: 12px;
  overflow: hidden;
}

#csv-preview-table thead {
  background: var(--ui-primary);
}

#csv-preview-table thead th {
  color: white !important;
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 12px;
}

#csv-preview-table tbody td {
  padding: 10px 12px;
  border-color: var(--ui-border);
}

/* Submit section */
.import-actions {
  margin-top: 32px;
  display: flex;
  gap: 12px;
}

.import-submit {
  flex: 1;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  background: linear-gradient(135deg, var(--ui-primary) 0%, var(--brand-600) 100%);
  border: none;
  border-radius: 14px;
  color: white;
  cursor: pointer;
  transition: all 200ms ease;
  box-shadow: 0 4px 14px rgba(33, 44, 77, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.import-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(33, 44, 77, 0.3);
}

.import-submit:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Danger zone */
.danger-zone {
  margin-top: 48px;
  padding: 24px;
  background: rgba(239, 68, 68, 0.04);
  border: 1px solid rgba(239, 68, 68, 0.15);
  border-radius: 16px;
}

.danger-zone h5 {
  font-size: 14px;
  font-weight: 600;
  color: #dc2626;
  margin-bottom: 8px;
}

.danger-zone p {
  font-size: 13px;
  color: var(--ui-muted);
  margin-bottom: 16px;
}

.danger-zone .btn-danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border: none;
  padding: 12px 20px;
  font-weight: 600;
  border-radius: 10px;
}

/* ============================================
   IMPORT CSV DARK MODE STYLES
   ============================================ */

body.dark-mode .import-container {
  color: var(--ui-text);
}

body.dark-mode .import-header h1,
body.dark-mode .import-header h2 {
  color: var(--ui-text) !important;
}

body.dark-mode .import-header p {
  color: var(--ui-muted) !important;
}

body.dark-mode .import-header-icon {
  background: var(--ui-surface) !important;
  border-color: var(--ui-border) !important;
}

body.dark-mode .upload-zone {
  background: var(--ui-surface) !important;
  border-color: var(--ui-border) !important;
}

body.dark-mode .upload-zone:hover {
  border-color: var(--brand-500) !important;
  background: var(--ui-bg) !important;
}

body.dark-mode .upload-zone-icon {
  background: var(--ui-bg) !important;
}

body.dark-mode .upload-zone-title {
  color: var(--ui-text) !important;
}

body.dark-mode .upload-zone-desc {
  color: var(--ui-muted) !important;
}

body.dark-mode .file-selected {
  background: var(--ui-surface) !important;
  border-color: var(--ui-border) !important;
}

body.dark-mode .file-selected-icon {
  background: var(--ui-bg) !important;
}

body.dark-mode .file-selected-info h4 {
  color: var(--ui-text) !important;
}

body.dark-mode .file-selected-info p {
  color: var(--ui-muted) !important;
}

body.dark-mode #csv-preview {
  background: var(--ui-surface) !important;
  border-color: var(--ui-border) !important;
}

body.dark-mode #csv-preview h4 {
  color: var(--ui-text) !important;
  border-color: var(--ui-border) !important;
}

body.dark-mode #csv-preview-table {
  background: var(--ui-surface) !important;
  color: var(--ui-text) !important;
}

body.dark-mode #csv-preview-table th {
  background: var(--ui-bg) !important;
  color: var(--ui-text) !important;
}

body.dark-mode #csv-preview-table td {
  border-color: var(--ui-border) !important;
  color: var(--ui-text) !important;
}

body.dark-mode .import-actions {
  background: var(--ui-surface) !important;
  border-color: var(--ui-border) !important;
}

body.dark-mode .danger-zone {
  background: rgba(239, 68, 68, 0.1) !important;
  border-color: rgba(239, 68, 68, 0.3) !important;
}

body.dark-mode .danger-zone p {
  color: var(--ui-muted) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="import-container">
  <div class="import-header">
    <div class="import-header-icon">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    </div>
    <h2 data-i18n="import.title">Import Accident Data</h2>
    <p data-i18n="import.subtitle">Upload a CSV file to bulk import traffic accident records</p>
  </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mt-3">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data" class="mt-3">
      <div class="upload-zone" id="upload-zone">
        <div class="upload-zone-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
        </div>
        <div class="upload-zone-title" data-i18n="import.dropHere">Drop your CSV file here</div>
        <div class="upload-zone-desc" data-i18n="import.orBrowse">or click to browse from your computer</div>
        <div class="upload-zone-button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span data-i18n="import.chooseFile">Choose File</span>
        </div>
        <input type="file" id="file" name="file" accept=".csv" required>
      </div>

      <div id="file-selected" class="file-selected" style="display: none;">
        <div class="file-selected-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
        </div>
        <div class="file-selected-info">
          <div class="file-selected-name" id="file-name">filename.csv</div>
          <div class="file-selected-size" id="file-size">0 KB</div>
        </div>
        <button type="button" class="file-selected-remove" id="clear-file-btn" title="Remove file">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>

      <div class="import-actions">
        <button type="submit" class="import-submit" id="submit-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span data-i18n="import.uploadImport">Upload &amp; Import</span>
        </button>
      </div>
    </form>

    <!-- CSV preview: shows the actual headers and a few sample rows from the selected file -->
    <div id="csv-preview" class="mt-4" style="display:none">
      <h5 data-i18n="import.csvPreview">CSV Preview</h5>
      <div class="table-responsive">
        <table id="csv-preview-table" class="table table-sm table-bordered">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="form-text" data-i18n="import.previewNote">Preview shows the first few rows only. The import will still map required fields (Date, Location, Severity) using flexible aliases.</div>
    </div>

  {% if session.role == "government" %}
  <div class="danger-zone">
    <h5 data-i18n="import.dangerZone">⚠️ Danger Zone</h5>
    <p data-i18n="import.dangerZoneDesc">Permanently delete all records that were imported via CSV. This action cannot be undone.</p>
    <form method="POST" onsubmit="return confirm('Are you sure you want to permanently delete ALL imported records? This cannot be undone.');">
      <input type="hidden" name="action" value="delete">
      <button type="submit" class="btn btn-danger" data-i18n="import.clearAll">Clear all imported records</button>
    </form>
  </div>
  {% endif %}
</div>

  <script>
  // Client-side CSV preview so the UI adapts to the uploaded file's headers
  (function(){
    const fileInput = document.getElementById('file');
    const preview = document.getElementById('csv-preview');
    const table = document.getElementById('csv-preview-table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const uploadZone = document.getElementById('upload-zone');
    const fileSelected = document.getElementById('file-selected');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const clearBtn = document.getElementById('clear-file-btn');
    const MAX_BYTES = 128 * 1024; // read up to 128KB for preview

    if (!fileInput || !preview) return;

    // Format file size
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Handle file selection
    fileInput.addEventListener('change', function() {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileName.textContent = file.name;
        fileSize.textContent = formatSize(file.size);
        uploadZone.style.display = 'none';
        fileSelected.style.display = 'flex';
      }
    });

    // Clear file selection
    clearBtn.addEventListener('click', function() {
      fileInput.value = '';
      uploadZone.style.display = 'block';
      fileSelected.style.display = 'none';
      preview.style.display = 'none';
    });

    // Drag and drop
    uploadZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', function() {
      uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });

    function splitCSVLine(line) {
      const out = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          out.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function loadPreview() {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { preview.style.display = 'none'; return; }

      const slice = f.slice ? f.slice(0, MAX_BYTES) : f;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result || '';
        const lines = text.replace(/\r\n/g, '\n').replace(/\r/g,'\n').split('\n').filter(Boolean);
        if (lines.length === 0) { preview.style.display = 'none'; return; }

        const headers = splitCSVLine(lines[0]);
        thead.innerHTML = '';
        const htr = document.createElement('tr');
        headers.forEach(h => { const th = document.createElement('th'); th.textContent = h || '(empty)'; htr.appendChild(th); });
        thead.appendChild(htr);

        tbody.innerHTML = '';
        const sampleCount = Math.min(5, Math.max(0, lines.length - 1));
        for (let i = 0; i < sampleCount; i++) {
          const rowLine = lines[i+1];
          const cols = splitCSVLine(rowLine);
          const tr = document.createElement('tr');
          for (let c = 0; c < headers.length; c++) {
            const td = document.createElement('td');
            td.textContent = (cols[c] !== undefined) ? cols[c] : '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        preview.style.display = '';
      };
      reader.onerror = function() { preview.style.display = 'none'; };
      try { reader.readAsText(slice, 'utf-8'); } catch (e) { preview.style.display = 'none'; }
    }

    // Trigger preview when file is selected
    fileInput.addEventListener('change', loadPreview);
  })();
  </script>
</div>
{% endblock %}
