{% extends "base_private.html" %}
{% from "ui/icons.html" import ui_icon %}

{% block title %}Statistics{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/map-timeline.css') }}" />
  <script src="{{ url_for('static', filename='js/map-timeline.js') }}"></script>
{% endblock %}

{% block content %}
<style>
  /* === STATS PAGE - PREMIUM DESIGN === */
  
  .stats-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px 24px;
    padding-bottom: 80px;
  }

  /* === PAGE HEADER - PREMIUM === */
  .stats-header {
    text-align: center;
    margin-bottom: 24px;
    padding: 24px 20px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.04) 0%, rgba(139, 92, 246, 0.04) 100%);
    border-radius: 20px;
    border: 1px solid rgba(59, 130, 246, 0.1);
    position: relative;
    overflow: hidden;
  }

  .stats-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
  }

  .stats-header-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    color: #3b82f6;
    position: relative;
    animation: headerIconFloat 3s ease-in-out infinite;
  }

  @keyframes headerIconFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  .stats-header-icon::after {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 20px;
    border: 2px solid transparent;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(139, 92, 246, 0.4)) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }

  .stats-header h1 {
    font-weight: 800;
    font-size: 1.75rem;
    color: var(--ui-text);
    margin-bottom: 8px;
    letter-spacing: -0.02em;
  }

  .stats-header p {
    color: var(--ui-muted);
    font-size: 0.9rem;
    margin: 0;
    max-width: 400px;
    margin: 0 auto;
  }

  body.dark-mode .stats-header {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
    border-color: rgba(59, 130, 246, 0.15);
  }

  /* === TAB NAVIGATION - PREMIUM === */
  .stats-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 24px;
    padding: 6px;
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 16px;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  }

  .stats-tab {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    border: none;
    background: transparent;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    color: var(--ui-muted);
    cursor: pointer;
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .stats-tab:hover {
    color: var(--ui-text);
    background: rgba(59, 130, 246, 0.06);
  }

  .stats-tab.active {
    background: linear-gradient(135deg, var(--ui-primary) 0%, var(--brand-600) 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
  }

  body.light-mode .stats-tab.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
  }

  .stats-tab .ui-icon {
    width: 18px;
    height: 18px;
  }

  /* Tab badge for counts */
  .stats-tab .tab-badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.2);
    font-weight: 700;
  }

  .stats-tab:not(.active) .tab-badge {
    background: rgba(59, 130, 246, 0.1);
    color: var(--ui-primary);
  }

  body.dark-mode .stats-tabs {
    background: var(--brand-700);
    border-color: var(--ui-border-strong);
  }

  body.dark-mode .stats-tab:hover {
    background: rgba(209, 219, 249, 0.08);
  }

  /* === CAROUSEL PAGES === */
  #statsCarousel {
    overflow: visible;
  }
  
  .carousel-page {
    display: none !important;
    animation: fadeInPage 300ms ease;
  }

  .carousel-page.active {
    display: block !important;
  }

  @keyframes fadeInPage {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* === FILTER CARD === */
  .filter-card {
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 28px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .filter-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--ui-border);
  }

  .filter-card-header h6 {
    font-size: 15px;
    font-weight: 700;
    color: var(--ui-text);
    margin: 0;
  }

  .filter-card-header .filter-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3b82f6;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    align-items: end;
  }

  .filter-grid label {
    font-size: 12px;
    font-weight: 600;
    color: var(--ui-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 6px;
    display: block;
  }

  .filter-grid .form-control,
  .filter-grid .form-select {
    border-radius: 10px;
    border: 1.5px solid var(--ui-border);
    padding: 10px 14px;
    font-size: 14px;
    transition: all 200ms ease;
  }

  .filter-grid .form-control:focus,
  .filter-grid .form-select:focus {
    border-color: var(--ui-primary);
    box-shadow: 0 0 0 3px var(--ui-focus);
  }

  .filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .filter-actions .btn-primary {
    background: linear-gradient(135deg, var(--ui-primary) 0%, var(--brand-600) 100%);
    border: none;
    padding: 10px 24px;
    border-radius: 10px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(33, 44, 77, 0.2);
    transition: all 200ms ease;
  }

  .filter-actions .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(33, 44, 77, 0.3);
  }

  .filter-actions .btn-outline-secondary {
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
  }

  /* === KPI CARDS === */
  #kpiGrid {
    margin-bottom: 0;
  }

  .kpi-card {
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 16px;
    padding: 24px 20px;
    text-align: center;
    height: 100%;
    position: relative;
    overflow: hidden;
    transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--kpi-color, var(--ui-primary));
    border-radius: 16px 16px 0 0;
  }

  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .kpi-card .kpi-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    color: var(--kpi-color, #3b82f6);
  }

  .kpi-card .kpi-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--ui-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 8px;
  }

  .kpi-card .kpi-value {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--ui-text);
    letter-spacing: -0.02em;
    line-height: 1;
  }

  .kpi-card .kpi-value.small-text {
    font-size: 1rem;
    font-weight: 700;
  }

  /* KPI card colors */
  .kpi-card[data-color="blue"] { --kpi-color: #3b82f6; }
  .kpi-card[data-color="green"] { --kpi-color: #22c55e; }
  .kpi-card[data-color="purple"] { --kpi-color: #8b5cf6; }
  .kpi-card[data-color="orange"] { --kpi-color: #f59e0b; }
  .kpi-card[data-color="red"] { --kpi-color: #ef4444; }
  .kpi-card[data-color="cyan"] { --kpi-color: #06b6d4; }
  .kpi-card[data-color="pink"] { --kpi-color: #ec4899; }
  .kpi-card[data-color="teal"] { --kpi-color: #14b8a6; }

  .kpi-card[data-color] .kpi-icon {
    background: linear-gradient(135deg, color-mix(in srgb, var(--kpi-color) 15%, transparent) 0%, color-mix(in srgb, var(--kpi-color) 5%, transparent) 100%);
    color: var(--kpi-color);
  }

  /* KPI row animation */
  #kpiGrid > div {
    opacity: 0;
    animation: kpiFadeIn 400ms ease forwards;
  }
  #kpiGrid > div:nth-child(1) { animation-delay: 50ms; }
  #kpiGrid > div:nth-child(2) { animation-delay: 100ms; }
  #kpiGrid > div:nth-child(3) { animation-delay: 150ms; }
  #kpiGrid > div:nth-child(4) { animation-delay: 200ms; }
  #kpiGrid > div:nth-child(5) { animation-delay: 250ms; }
  #kpiGrid > div:nth-child(6) { animation-delay: 300ms; }
  #kpiGrid > div:nth-child(7) { animation-delay: 350ms; }
  #kpiGrid > div:nth-child(8) { animation-delay: 400ms; }

  @keyframes kpiFadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  body.dark-mode .kpi-card {
    background: var(--brand-700);
    border-color: var(--ui-border-strong);
  }

  /* === CHART CARDS === */
  .chart-card {
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 250ms ease;
  }

  .chart-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .chart-card.mb-0 {
    margin-bottom: 0;
  }

  .chart-card .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--ui-border);
  }

  .chart-card h6 {
    font-weight: 700;
    font-size: 1rem;
    color: var(--ui-text);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chart-canvas {
    width: 100% !important;
    height: 280px !important;
    display: block;
  }

  /* Doughnut charts */
  #severityChart.chart-canvas,
  #statusChart.chart-canvas {
    max-width: 260px;
    height: 260px !important;
    aspect-ratio: 1 / 1;
    margin: 0 auto;
  }

  /* Bar charts */
  #causeChart.chart-canvas,
  #delegationChart.chart-canvas,
  #severityGovChart.chart-canvas,
  #severityDelChart.chart-canvas,
  #causeSeverityChart.chart-canvas {
    height: 300px !important;
  }

  /* Time chart */
  #timeChart.chart-canvas {
    height: 320px !important;
  }

  #confirmedReportedChart.chart-canvas {
    height: 280px !important;
  }

  /* Chart grid */
  .charts-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    margin-bottom: 24px;
  }

  .charts-row .chart-card {
    margin-bottom: 0;
  }

  @media (max-width: 768px) {
    .charts-row {
      grid-template-columns: 1fr;
    }
  }

  /* Granularity buttons */
  .gran-group {
    gap: 4px;
  }

  .gran-group .btn {
    border-radius: 8px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
  }

  .gran-group .btn.active {
    background: var(--ui-primary) !important;
    color: white !important;
    border-color: var(--ui-primary) !important;
  }

  body.dark-mode .chart-card {
    background: var(--brand-700);
    border-color: var(--ui-border-strong);
  }

  /* === HEATMAP === */
  .heatmap-container {
    overflow-x: auto;
    padding: 8px 0;
  }

  .heatmap-grid {
    display: flex;
    flex-direction: column;
    gap: 3px;
    width: fit-content;
    margin: 0 auto;
  }

  .hm-row {
    display: flex;
    gap: 3px;
  }

  .hm-cell {
    min-width: 42px;
    width: 42px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 11px;
    border-radius: 8px;
    flex-shrink: 0;
    transition: transform 150ms ease, box-shadow 150ms ease;
  }

  .hm-cell:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1;
  }

  .hm-row-label {
    min-width: 36px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--ui-muted);
  }

  .hm-header {
    display: flex;
    gap: 3px;
    margin-bottom: 4px;
    padding-left: 39px;
  }

  .hm-header-cell {
    min-width: 42px;
    width: 42px;
    text-align: center;
    font-size: 10px;
    font-weight: 600;
    color: var(--ui-muted);
  }

  /* === RESPONSIVE === */
  @media (max-width: 576px) {
    .stats-container {
      padding: 16px;
    }

    .stats-header h1 {
      font-size: 1.5rem;
    }

    .stats-tabs {
      flex-direction: column;
      width: 100%;
    }

    .stats-tab {
      justify-content: center;
    }

    .filter-card {
      padding: 16px;
    }

    .kpi-card {
      padding: 16px;
    }

    .kpi-card .kpi-value {
      font-size: 1.25rem;
    }

    .chart-card {
      padding: 16px;
    }
  }

  /* === MAP PAGE - SIMPLE RELIABLE LAYOUT === */
  
  /* =====================================================
     MAP PAGE - COMPLETE REDESIGN
     ===================================================== */
  
  /* Page Container - only apply flex when active */
  #stats-map.active {
    display: flex !important;
    flex-direction: column;
    gap: 24px;
  }

  /* Map Page Header */
  .map-page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.25);
    position: relative;
    overflow: hidden;
  }

  .map-page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.5;
  }

  .map-header-content {
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
    z-index: 1;
  }

  .map-header-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .map-header-text h3 {
    font-size: 18px;
    font-weight: 700;
    color: white;
    margin: 0 0 4px 0;
  }

  .map-header-text p {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.85);
    margin: 0;
  }

  .map-header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    z-index: 1;
  }

  .map-region-select {
    padding: 10px 36px 10px 14px;
    font-size: 13px;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    min-width: 160px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
  }

  .map-region-select option {
    background: var(--ui-surface);
    color: var(--ui-text);
  }

  .map-reset-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .map-reset-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Quick Stats */
  .map-quick-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }

  @media (max-width: 1000px) {
    .map-quick-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 500px) {
    .map-quick-stats {
      grid-template-columns: 1fr;
    }
  }

  .map-quick-stat {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 14px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
  }

  .map-quick-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .quick-stat-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .quick-stat-icon.blue { background: rgba(59, 130, 246, 0.12); color: #3b82f6; }
  .quick-stat-icon.red { background: rgba(239, 68, 68, 0.12); color: #ef4444; }
  .quick-stat-icon.purple { background: rgba(139, 92, 246, 0.12); color: #8b5cf6; }
  .quick-stat-icon.green { background: rgba(34, 197, 94, 0.12); color: #22c55e; }

  .quick-stat-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .quick-stat-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--ui-text);
    line-height: 1.1;
  }

  .quick-stat-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--ui-muted);
  }

  /* Main Map Container */
  .map-main-container {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 1100px) {
    .map-main-container {
      grid-template-columns: 1fr;
    }
  }

  /* Map Section */
  .map-section {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .map-wrapper {
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
  }

  #map {
    width: 100%;
    height: 520px;
    background: #e8eaed;
  }

  body.dark-mode #map {
    background: #1e2028;
  }

  /* Map Legend */
  .map-legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 12px;
    padding: 14px 18px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    z-index: 1000;
    max-width: 200px;
    backdrop-filter: blur(8px);
  }

  .legend-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--ui-text);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-title svg {
    color: #3b82f6;
  }

  .legend-description {
    font-size: 11px;
    color: var(--ui-muted);
    margin: 0 0 12px 0;
    line-height: 1.4;
  }

  .legend-scale {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--ui-text);
  }

  .legend-color {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  /* Cluster legend mini-markers */
  .legend-cluster {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }

  .legend-cluster.cluster-small {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
  }

  .legend-cluster.cluster-medium {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
  }

  .legend-cluster.cluster-large {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  }

  .legend-tip {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--ui-border);
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--ui-muted);
  }

  .legend-tip svg {
    color: #8b5cf6;
    flex-shrink: 0;
  }

  /* Region Panel */
  .region-panel {
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
  }

  .region-panel-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 20px;
    background: var(--ui-bg);
    border-bottom: 1px solid var(--ui-border);
    font-size: 14px;
    font-weight: 600;
    color: var(--ui-text);
  }

  .region-panel-header svg {
    color: var(--ui-muted);
  }

  /* Empty State */
  .region-empty {
    padding: 48px 24px;
    text-align: center;
  }

  .region-empty-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8b5cf6;
    margin: 0 auto 20px;
  }

  .region-empty h6 {
    font-size: 15px;
    font-weight: 600;
    color: var(--ui-text);
    margin: 0 0 8px 0;
  }

  .region-empty p {
    font-size: 13px;
    color: var(--ui-muted);
    margin: 0;
    line-height: 1.5;
  }

  /* Region Content */
  .region-content {
    padding: 20px;
  }

  .region-name-section {
    display: flex;
    align-items: center;
    gap: 14px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--ui-border);
    margin-bottom: 16px;
  }

  .region-avatar {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 20px;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .region-name-info {
    flex: 1;
  }

  .region-type {
    font-size: 11px;
    font-weight: 600;
    color: var(--ui-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .region-name-info h4 {
    font-size: 18px;
    font-weight: 700;
    color: var(--ui-text);
    margin: 2px 0 0 0;
  }

  /* Stats Grid */
  .region-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  .region-stat-card {
    background: rgba(59, 130, 246, 0.08);
    border: 1px solid rgba(59, 130, 246, 0.15);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }

  .region-stat-card.danger {
    background: rgba(239, 68, 68, 0.08);
    border-color: rgba(239, 68, 68, 0.15);
  }

  .stat-number {
    display: block;
    font-size: 24px;
    font-weight: 800;
    color: var(--ui-text);
    line-height: 1;
    margin-bottom: 4px;
  }

  .region-stat-card.danger .stat-number {
    color: #ef4444;
  }

  .stat-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--ui-muted);
    text-transform: uppercase;
  }

  /* Info Row */
  .region-info-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--ui-bg);
    border-radius: 12px;
    margin-bottom: 16px;
  }

  .info-row-icon {
    width: 36px;
    height: 36px;
    background: rgba(245, 158, 11, 0.12);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f59e0b;
    flex-shrink: 0;
  }

  .info-row-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .info-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--ui-muted);
    text-transform: uppercase;
  }

  .info-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--ui-text);
  }

  /* Chart Section */
  .region-chart-section {
    background: var(--ui-bg);
    border-radius: 12px;
    overflow: hidden;
  }

  .chart-section-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--ui-border);
    font-size: 13px;
    font-weight: 600;
    color: var(--ui-text);
  }

  .chart-section-header svg {
    color: var(--ui-muted);
  }

  .chart-section-body {
    height: 120px;
    padding: 12px;
  }

  .chart-section-body canvas {
    width: 100% !important;
    height: 100% !important;
  }

  /* Dark Mode */
  body.dark-mode .map-page-header {
    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.15);
  }

  body.dark-mode .map-quick-stat {
    background: rgba(30, 32, 40, 0.8);
    border-color: rgba(255, 255, 255, 0.08);
  }

  body.dark-mode .map-quick-stat:hover {
    background: rgba(40, 42, 54, 0.9);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  body.dark-mode .map-wrapper,
  body.dark-mode .region-panel {
    background: rgba(30, 32, 40, 0.8);
    border-color: rgba(255, 255, 255, 0.08);
  }

  body.dark-mode .map-legend {
    background: rgba(30, 32, 40, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-mode .region-panel-header,
  body.dark-mode .region-info-row,
  body.dark-mode .region-chart-section {
    background: rgba(20, 22, 28, 0.6);
  }

  body.dark-mode .region-stat-card {
    background: rgba(59, 130, 246, 0.12);
    border-color: rgba(59, 130, 246, 0.2);
  }

  body.dark-mode .region-stat-card.danger {
    background: rgba(239, 68, 68, 0.12);
    border-color: rgba(239, 68, 68, 0.2);
  }

  body.dark-mode .region-name-info h4,
  body.dark-mode .stat-number {
    color: var(--ui-text);
  }

  body.dark-mode .region-type,
  body.dark-mode .stat-label {
    color: var(--ui-muted);
  }

  body.dark-mode .region-empty h6 {
    color: var(--ui-text);
  }

  body.dark-mode .region-empty p {
    color: var(--ui-muted);
  }

  body.dark-mode .region-empty-icon {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
  }

  /* Responsive Map Header */
  @media (max-width: 768px) {
    .map-page-header {
      flex-direction: column;
      gap: 16px;
      text-align: center;
      padding: 20px;
    }
    
    .map-header-content {
      flex-direction: column;
      text-align: center;
    }
    
    .map-header-actions {
      flex-direction: column;
      width: 100%;
    }
    
    .map-region-select,
    .map-reset-btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Leaflet Controls */
  .leaflet-control-zoom {
    border: none !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
    border-radius: 12px !important;
    overflow: hidden;
  }

  .leaflet-control-zoom a {
    background: var(--ui-surface) !important;
    color: var(--ui-text) !important;
    border: none !important;
    width: 36px !important;
    height: 36px !important;
    line-height: 36px !important;
    font-size: 16px !important;
  }

  .leaflet-control-zoom a:hover {
    background: var(--ui-bg) !important;
    color: var(--ui-primary) !important;
  }

  .leaflet-control-back {
    background: var(--ui-surface) !important;
    border: none !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
    border-radius: 10px !important;
    padding: 10px 14px !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    color: var(--ui-text) !important;
  }

  .leaflet-control-back:hover {
    background: var(--ui-primary) !important;
    color: white !important;
  }

  body.dark-mode .leaflet-control-zoom a,
  body.dark-mode .leaflet-control-back {
    background: var(--brand-700) !important;
  }

  /* Leaflet Popup Styling */
  .leaflet-popup-content-wrapper {
    border-radius: 14px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18) !important;
    padding: 0 !important;
    overflow: hidden;
    border: 1px solid var(--ui-border);
  }

  .leaflet-popup-content {
    margin: 0 !important;
    min-width: 200px;
  }

  .leaflet-popup-tip {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
  }

  body.dark-mode .leaflet-popup-content-wrapper {
    background: var(--brand-700) !important;
    border-color: var(--ui-border-strong) !important;
  }

  body.dark-mode .leaflet-popup-tip {
    background: var(--brand-700) !important;
  }

  /* Marker Cluster Styling */
  .marker-cluster {
    background-clip: padding-box;
  }

  .marker-cluster div {
    width: 36px;
    height: 36px;
    margin-left: 4px;
    margin-top: 4px;
    text-align: center;
    border-radius: 18px;
    font: 13px "SF Pro Display", -apple-system, sans-serif;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .marker-cluster-small {
    background-color: rgba(59, 130, 246, 0.25);
    border: 2px solid rgba(59, 130, 246, 0.6);
    box-shadow: 0 0 12px rgba(59, 130, 246, 0.4), inset 0 0 8px rgba(59, 130, 246, 0.2);
  }
  .marker-cluster-small div {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
  }

  .marker-cluster-medium {
    background-color: rgba(245, 158, 11, 0.25);
    border: 2px solid rgba(245, 158, 11, 0.6);
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.4), inset 0 0 8px rgba(245, 158, 11, 0.2);
  }
  .marker-cluster-medium div {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.5);
  }

  .marker-cluster-large {
    background-color: rgba(239, 68, 68, 0.25);
    border: 2px solid rgba(239, 68, 68, 0.6);
    box-shadow: 0 0 12px rgba(239, 68, 68, 0.4), inset 0 0 8px rgba(239, 68, 68, 0.2);
    animation: pulse-cluster 2s ease-in-out infinite;
  }
  .marker-cluster-large div {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
  }

  @keyframes pulse-cluster {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.9; }
  }

  /* Cluster hover effect */
  .marker-cluster:hover {
    transform: scale(1.1);
    z-index: 1000 !important;
  }

  .marker-cluster {
    transition: transform 0.2s ease;
  }

  /* Fullscreen Mode for Map */
  .map-main-card:fullscreen {
    border-radius: 0;
    background: var(--ui-bg);
  }

  .map-main-card:fullscreen #map {
    height: calc(100vh - 80px) !important;
    max-height: none !important;
    min-height: calc(100vh - 80px) !important;
  }

  .map-main-card:fullscreen .map-toolbar {
    border-radius: 0;
  }

  .map-main-card:fullscreen .map-floating-stats {
    bottom: 30px;
    left: 30px;
    right: 30px;
  }

  /* Map Loading State */
  .map-loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    gap: 16px;
    backdrop-filter: blur(4px);
  }

  body.dark-mode .map-loading-overlay {
    background: rgba(11, 18, 32, 0.9);
  }

  .map-loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--ui-border);
    border-top-color: var(--ui-primary);
    border-radius: 50%;
    animation: mapSpin 1s linear infinite;
  }

  @keyframes mapSpin {
    to { transform: rotate(360deg); }
  }

  .map-loading-text {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--ui-muted);
  }

  /* Hover effects for map regions */
  .leaflet-interactive:hover {
    cursor: pointer;
  }

  /* Custom attribution styling */
  .leaflet-control-attribution {
    background: var(--ui-surface) !important;
    color: var(--ui-muted) !important;
    font-size: 10px !important;
    padding: 4px 8px !important;
    border-radius: 8px 0 0 0 !important;
    opacity: 0.8;
    transition: opacity 200ms ease;
  }

  .leaflet-control-attribution:hover {
    opacity: 1;
  }

  body.dark-mode .leaflet-control-attribution {
    background: var(--brand-700) !important;
  }

  /* Map tooltip styling */
  .map-tooltip {
    background: var(--ui-surface);
    border: 1px solid var(--ui-border);
    border-radius: 10px;
    padding: 12px 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    font-size: 13px;
    min-width: 180px;
  }

  .map-tooltip-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--ui-border);
  }

  .map-tooltip-header .tooltip-region {
    font-weight: 700;
    font-size: 14px;
    color: var(--ui-text);
  }

  .map-tooltip-stats {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .map-tooltip-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .map-tooltip-stat .label {
    font-size: 12px;
    color: var(--ui-muted);
  }

  .map-tooltip-stat .value {
    font-size: 13px;
    font-weight: 600;
    color: var(--ui-text);
  }

  body.dark-mode .map-tooltip {
    background: var(--brand-700);
    border-color: var(--ui-border-strong);
  }

  /* === SKELETON LOADERS === */
  .skeleton {
    background: linear-gradient(90deg, rgba(174, 185, 225, 0.15) 25%, rgba(174, 185, 225, 0.3) 50%, rgba(174, 185, 225, 0.15) 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite ease-in-out;
    border-radius: 10px;
  }

  .skeleton-card {
    height: 32px;
    width: 80px;
    margin: 0 auto;
    border-radius: 8px;
  }

  body.dark-mode .skeleton {
    background: linear-gradient(90deg, rgba(209, 219, 249, 0.08) 25%, rgba(209, 219, 249, 0.16) 50%, rgba(209, 219, 249, 0.08) 75%);
    background-size: 200% 100%;
  }

  @keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* === RESPONSIVE === */
  @media (max-width: 768px) {
    .stats-container {
      padding: 16px;
    }

    .stats-header {
      padding: 20px 16px;
    }

    .stats-header h1 {
      font-size: 1.4rem;
    }

    .stats-header-icon {
      width: 52px;
      height: 52px;
    }

    .stats-tabs {
      width: 100%;
      justify-content: center;
      padding: 4px;
    }

    .stats-tab {
      padding: 10px 16px;
      font-size: 13px;
      flex: 1;
      justify-content: center;
    }

    .stats-tab span {
      display: none;
    }

    .stats-tab .ui-icon {
      margin: 0;
    }

    .filter-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  @media (max-width: 480px) {
    .stats-tab {
      padding: 10px 12px;
    }
  }
</style>

<div class="stats-container">
  <!-- Page header -->
  <div class="stats-header">
    <div class="stats-header-icon">
      {{ ui_icon('chart', 'ui-icon', 28) }}
    </div>
    <h1 data-i18n="stats.title">Statistics & Analytics</h1>
    <p data-i18n="stats.subtitle">Explore accident data with interactive visualizations and geographic insights</p>
    
    <!-- Export Button -->
    <div class="export-dropdown mt-3">
      <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="statsExportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        Export Statistics
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="statsExportDropdown">
        <li><a class="dropdown-item" href="#" onclick="exportStatistics('csv'); return false;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          Export as CSV
        </a></li>
        <li><a class="dropdown-item" href="#" onclick="exportStatistics('excel'); return false;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>
          Export as Excel
        </a></li>
        <li><a class="dropdown-item" href="#" onclick="exportStatistics('pdf'); return false;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
          Export as PDF
        </a></li>
      </ul>
    </div>
  </div>

  <!-- Tab navigation -->
  <div class="stats-tabs" role="tablist">
    <button id="navSummary" class="stats-tab active" role="tab" aria-selected="true">
      {{ ui_icon('dashboard', 'ui-icon') }}
      <span data-i18n="stats.summary">Summary</span>
    </button>
    <button id="navCharts" class="stats-tab" role="tab" aria-selected="false">
      {{ ui_icon('chart', 'ui-icon') }}
      <span data-i18n="stats.visuals">Visuals</span>
    </button>
    <button id="navMap" class="stats-tab" role="tab" aria-selected="false">
      {{ ui_icon('location', 'ui-icon') }}
      <span data-i18n="stats.map">Map</span>
    </button>
    <button id="navPredictions" class="stats-tab" role="tab" aria-selected="false">
      {{ ui_icon('flash', 'ui-icon') }}
      <span data-i18n="stats.predictions">Predictions</span>
    </button>
  </div>

  <!-- Content pages -->
  <div id="statsCarousel">
    <!-- Page 1: Summary (KPIs + Filters) -->
    <div class="carousel-page active" data-page="0" id="stats-summary">
      <!-- Filters -->
      <div class="filter-card">
        <div class="filter-card-header">
          <div class="filter-icon">
            {{ ui_icon('filter', 'ui-icon') }}
          </div>
          <h6 data-i18n="stats.filterData">Filter Data</h6>
        </div>
        <form id="statsFilterForm" class="filter-grid">
          <div>
            <label data-i18n="stats.from">From</label>
            <input id="filterStart" type="date" class="form-control form-control-sm" />
          </div>
          <div>
            <label data-i18n="stats.to">To</label>
            <input id="filterEnd" type="date" class="form-control form-control-sm" />
          </div>
          <div>
            <label data-i18n="stats.year">Year</label>
            <select id="filterYear" class="form-select form-select-sm">
              <option value="" data-i18n="stats.allYears">All years</option>
            </select>
          </div>
          <div>
            <label data-i18n="stats.month">Month</label>
            <select id="filterMonth" class="form-select form-select-sm">
              <option value="" data-i18n="stats.allMonths">All months</option>
            </select>
          </div>
          <div>
            <label data-i18n="stats.governorate">Governorate</label>
            <select id="filterGovernorate" class="form-select form-select-sm">
              <option value="" data-i18n="stats.allGovernorates">All governorates</option>
            </select>
          </div>
          <div>
            <label data-i18n="stats.cause">Cause</label>
            <select id="filterCause" class="form-select form-select-sm">
              <option value="" data-i18n="stats.allCauses">All causes</option>
            </select>
          </div>
        </form>
        <div class="filter-actions">
          <button type="button" id="applyFilters" class="btn btn-primary">
            {{ ui_icon('check', 'ui-icon me-1', 16) }} <span data-i18n="stats.applyFilters">Apply Filters</span>
          </button>
          <button type="button" id="resetFilters" class="btn btn-outline-secondary" data-i18n="stats.reset">Reset</button>
        </div>
      </div>

      <!-- KPI cards -->
      <div class="row g-3 mb-4" id="kpiGrid">
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="blue">
            <div class="kpi-icon">
              {{ ui_icon('warning', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.totalAccidents">Total Accidents</div>
            <div id="totalAccidents" class="kpi-value" style="display:none;"></div>
            <div id="skeleton-total" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="green">
            <div class="kpi-icon">
              {{ ui_icon('calendar', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.thisYear">This Year</div>
            <div id="accidentsYTD" class="kpi-value" style="display:none;"></div>
            <div id="skeleton-ytd" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="cyan">
            <div class="kpi-icon">
              {{ ui_icon('clock', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.thisMonth">This Month</div>
            <div id="accidentsMTD" class="kpi-value" style="display:none;"></div>
            <div id="skeleton-mtd" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="red">
            <div class="kpi-icon">
              {{ ui_icon('danger', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.highSeverityRate">High Severity Rate</div>
            <div id="highSeverityRate" class="kpi-value" style="display:none;"></div>
            <div id="skeleton-highrate" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="orange">
            <div class="kpi-icon">
              {{ ui_icon('flash', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.topCause">Top Cause</div>
            <div id="topCause" class="kpi-value small-text" style="display:none;"></div>
            <div id="skeleton-topcause" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="purple">
            <div class="kpi-icon">
              {{ ui_icon('location', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.topGovernorate">Top Governorate</div>
            <div id="topGovernorate" class="kpi-value small-text" style="display:none;"></div>
            <div id="skeleton-topgov" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="teal">
            <div class="kpi-icon">
              {{ ui_icon('chart', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.avgPerDay">Avg / Day</div>
            <div id="avgPerDay" class="kpi-value" style="display:none;"></div>
            <div id="skeleton-avg" class="skeleton skeleton-card"></div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="kpi-card" data-color="pink">
            <div class="kpi-icon">
              {{ ui_icon('arrow', 'ui-icon', 24) }}
            </div>
            <div class="kpi-label" data-i18n="stats.yoyChange">YoY Change</div>
            <div id="yoyChangePct" class="kpi-value" style="display:none;"></div>
            <div id="skeleton-yoy" class="skeleton skeleton-card"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 2: Visuals (All Charts) -->
    <div class="carousel-page" data-page="1" id="stats-charts">
      
      <!-- Time Chart - Full Width -->
      <div class="chart-card">
        <div class="chart-header">
          <h6>{{ ui_icon('chart', 'ui-icon') }} <span data-i18n="stats.accidentsOverTime">Accidents Over Time</span></h6>
          <div class="d-flex align-items-center gap-2">
            <div class="btn-group btn-group-sm gran-group">
              <button type="button" id="gran-day" class="btn btn-outline-secondary" data-i18n="stats.day">Day</button>
              <button type="button" id="gran-month" class="btn btn-outline-secondary active" data-i18n="stats.monthBtn">Month</button>
              <button type="button" id="gran-year" class="btn btn-outline-secondary" data-i18n="stats.yearBtn">Year</button>
            </div>
            <div class="form-check form-switch ms-2">
              <input class="form-check-input" type="checkbox" id="toggleArea">
              <label class="form-check-label small" for="toggleArea" data-i18n="stats.area">Area</label>
            </div>
          </div>
        </div>
        <div id="skeleton-time" class="skeleton" style="height: 320px;"></div>
        <canvas id="timeChart" class="chart-canvas" style="display:none;"></canvas>
      </div>

      <!-- Row 1: Severity + Cause -->
      <div class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <h6>{{ ui_icon('danger', 'ui-icon') }} <span data-i18n="stats.bySeverity">By Severity</span></h6>
          </div>
          <div id="skeleton-severity" class="skeleton" style="width: 260px; height: 260px; border-radius: 50%; margin: 0 auto;"></div>
          <canvas id="severityChart" class="chart-canvas" style="display:none;"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h6>{{ ui_icon('flash', 'ui-icon') }} <span data-i18n="stats.byCause">By Cause</span></h6>
          </div>
          <div id="skeleton-cause" class="skeleton" style="height: 300px;"></div>
          <canvas id="causeChart" class="chart-canvas" style="display:none;"></canvas>
        </div>
      </div>

      <!-- Row 2: Delegation + Status -->
      <div class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <h6>{{ ui_icon('location', 'ui-icon') }} <span data-i18n="stats.topDelegations">Top Delegations</span></h6>
          </div>
          <div id="skeleton-delegation" class="skeleton" style="height: 300px;"></div>
          <canvas id="delegationChart" class="chart-canvas" style="display:none;"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h6>{{ ui_icon('check', 'ui-icon') }} <span data-i18n="stats.byStatus">By Status</span></h6>
          </div>
          <div id="skeleton-status" class="skeleton" style="width: 260px; height: 260px; border-radius: 50%; margin: 0 auto;"></div>
          <canvas id="statusChart" class="chart-canvas" style="display:none;"></canvas>
        </div>
      </div>

      <!-- Heatmap - Full Width -->
      <div class="chart-card">
        <div class="chart-header">
          <h6>{{ ui_icon('calendar', 'ui-icon') }} <span data-i18n="stats.dayHourHeatmap">Day &amp; Hour Heatmap</span></h6>
          <div id="heatmapLegend" class="small text-muted"></div>
        </div>
        <div id="skeleton-heatmap" class="skeleton" style="height: 200px;"></div>
        <div id="heatmapContent" class="heatmap-grid" style="display:none;"></div>
      </div>

      <!-- Row 3: Severity by Region + Cause by Severity -->
      <div class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <h6>{{ ui_icon('location', 'ui-icon') }} <span data-i18n="stats.severityByRegion">Severity by Region</span></h6>
            <select id="regionChartType" class="form-select form-select-sm" style="width: auto;">
              <option value="governorate" data-i18n="stats.governorateOption">Governorate</option>
              <option value="delegation" data-i18n="stats.delegationOption">Delegation</option>
            </select>
          </div>
          <!-- Governorate view -->
          <div id="sev-gov-container">
            <div id="skeleton-sev-gov" class="skeleton" style="height: 300px;"></div>
            <canvas id="severityGovChart" class="chart-canvas" style="display:none;"></canvas>
          </div>
          <!-- Delegation view (hidden by default) -->
          <div id="sev-del-container" style="display:none;">
            <div id="skeleton-sev-del" class="skeleton" style="height: 300px;"></div>
            <canvas id="severityDelChart" class="chart-canvas" style="display:none;"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h6>{{ ui_icon('chart', 'ui-icon') }} <span data-i18n="stats.causeBySeverity">Cause by Severity</span></h6>
          </div>
          <div id="skeleton-cause-sev" class="skeleton" style="height: 300px;"></div>
          <canvas id="causeSeverityChart" class="chart-canvas" style="display:none;"></canvas>
        </div>
      </div>

      <!-- Confirmed vs Reported - Full Width -->
      <div class="chart-card mb-0">
        <div class="chart-header">
          <h6>{{ ui_icon('check', 'ui-icon') }} <span data-i18n="stats.confirmedVsReported">Confirmed vs Reported</span></h6>
        </div>
        <div id="skeleton-confirmed" class="skeleton" style="height: 280px;"></div>
        <canvas id="confirmedReportedChart" class="chart-canvas" style="display:none;"></canvas>
      </div>
    </div>

    <!-- Page 3: Map -->
    <div class="carousel-page" data-page="2" id="stats-map">
      
      <!-- Map Page Header -->
      <div class="map-page-header">
        <div class="map-header-content">
          <div class="map-header-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
              <line x1="8" y1="2" x2="8" y2="18"></line>
              <line x1="16" y1="6" x2="16" y2="22"></line>
            </svg>
          </div>
          <div class="map-header-text">
            <h3 data-i18n="stats.geographicAnalysis">Geographic Analysis</h3>
            <p data-i18n="stats.geographicAnalysisDesc">Explore accident distribution across Tunisia's regions</p>
          </div>
        </div>
        <div class="map-header-actions">
          <select id="mapGovernorateSelect" class="map-region-select">
            <option value="" data-i18n="stats.allRegions">All Regions</option>
          </select>
          <button type="button" id="resetMapView" class="map-reset-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="1 4 1 10 7 10"></polyline>
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
            <span data-i18n="stats.resetView">Reset View</span>
          </button>
        </div>
      </div>

      <!-- Quick Stats Row -->
      <div class="map-quick-stats">
        <div class="map-quick-stat">
          <div class="quick-stat-icon blue">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            </svg>
          </div>
          <div class="quick-stat-content">
            <span class="quick-stat-value" id="mapTotalAccidents"></span>
            <span class="quick-stat-label" data-i18n="stats.totalAccidents">Total Accidents</span>
          </div>
        </div>
        <div class="map-quick-stat">
          <div class="quick-stat-icon red">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <div class="quick-stat-content">
            <span class="quick-stat-value" id="mapHighSeverity"></span>
            <span class="quick-stat-label" data-i18n="stats.highSeverity">High Severity</span>
          </div>
        </div>
        <div class="map-quick-stat">
          <div class="quick-stat-icon purple">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0Z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <div class="quick-stat-content">
            <span class="quick-stat-value">24</span>
            <span class="quick-stat-label" data-i18n="stats.governorates">Governorates</span>
          </div>
        </div>
        <div class="map-quick-stat">
          <div class="quick-stat-icon green">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
          </div>
          <div class="quick-stat-content">
            <span class="quick-stat-value" id="mapAvgDaily"></span>
            <span class="quick-stat-label" data-i18n="stats.dailyAverage">Daily Average</span>
          </div>
        </div>
      </div>

      <!-- Main Map Container -->
      <div class="map-main-container">
        <!-- Map Section -->
        <div class="map-section">
          <div class="map-wrapper">
            <div id="map"></div>
            <!-- Cluster Legend -->
            <div class="map-legend cluster-legend">
              <div class="legend-title">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 16v-4"></path>
                  <path d="M12 8h.01"></path>
                </svg>
                <span data-i18n="stats.accidentClusters">Accident Clusters</span>
              </div>
              <p class="legend-description" data-i18n="stats.clustersDesc">Numbers show grouped accidents. Click to zoom in.</p>
              <div class="legend-scale">
                <div class="legend-item">
                  <span class="legend-cluster cluster-small">5</span>
                  <span data-i18n="stats.accidents1to10">1-10 accidents</span>
                </div>
                <div class="legend-item">
                  <span class="legend-cluster cluster-medium">25</span>
                  <span data-i18n="stats.accidents11to50">11-50 accidents</span>
                </div>
                <div class="legend-item">
                  <span class="legend-cluster cluster-large">99</span>
                  <span data-i18n="stats.accidents50plus">50+ accidents</span>
                </div>
              </div>
              <div class="legend-tip">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <polyline points="9 21 3 21 3 15"></polyline>
                  <line x1="21" y1="3" x2="14" y2="10"></line>
                  <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
                <span data-i18n="stats.zoomTip">Zoom in to see individual locations</span>
              </div>
            </div>
          </div>
          
          <!-- Map Timeline with Play Button -->
          <div id="mapTimeline"></div>
        </div>

        <!-- Region Details Panel -->
        <div class="region-panel">
          <div class="region-panel-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span data-i18n="stats.regionDetails">Region Details</span>
          </div>
          
          <!-- Empty State -->
          <div class="region-empty" id="regionEmptyState">
            <div class="region-empty-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0Z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </div>
            <h6 data-i18n="stats.selectRegion">Select a Region</h6>
            <p data-i18n="stats.selectRegionDesc">Click on any region in the map to view detailed accident statistics</p>
          </div>

          <!-- Region Data Content -->
          <div class="region-content" id="regionData" style="display: none;">
            <!-- Region Name -->
            <div class="region-name-section">
              <div class="region-avatar" id="regionFlag">T</div>
              <div class="region-name-info">
                <span class="region-type">Governorate</span>
                <h4 id="regionName"></h4>
              </div>
            </div>

            <!-- Stats Grid -->
            <div class="region-stats-grid">
              <div class="region-stat-card">
                <span class="stat-number" id="regionTotal"></span>
                <span class="stat-label" data-i18n="stats.totalAccidents">Total Accidents</span>
              </div>
              <div class="region-stat-card danger">
                <span class="stat-number" id="regionHighPct"></span>
                <span class="stat-label" data-i18n="stats.highSeverity">High Severity</span>
              </div>
            </div>

            <!-- Top Cause -->
            <div class="region-info-row">
              <div class="info-row-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
              </div>
              <div class="info-row-content">
                <span class="info-label" data-i18n="stats.primaryCause">Primary Cause</span>
                <span class="info-value" id="regionTopCause"></span>
              </div>
            </div>

            <!-- Mini Chart -->
            <div class="region-chart-section">
              <div class="chart-section-header">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="20" x2="18" y2="10"></line>
                  <line x1="12" y1="20" x2="12" y2="4"></line>
                  <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                <span data-i18n="stats.monthlyTrend">Monthly Trend</span>
              </div>
              <div class="chart-section-body" id="regionMiniChart">
                <canvas id="regionMiniCanvas"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Page 4: Predictions -->
    <div class="carousel-page" data-page="3" id="stats-predictions">
      <!-- Predictions Header -->
      <div class="predictions-header">
        <div class="predictions-header-content">
          <div class="predictions-header-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
              <circle cx="12" cy="12" r="4"/>
            </svg>
          </div>
          <div class="predictions-header-text">
            <h3 data-i18n="stats.aiPredictions">AI-Powered Risk Predictions</h3>
            <p data-i18n="stats.aiPredictionsDesc">Advanced analytics to forecast accident patterns and identify high-risk conditions</p>
          </div>
        </div>
        <div class="predictions-header-badge">
          <span class="status-indicator"></span>
          <span data-i18n="stats.liveForecast">Live Forecast</span>
        </div>
      </div>

      <!-- Weekly Forecast - Full Width Top -->
      <div class="predictions-section">
        <div class="section-header">
          <h4 data-i18n="stats.weeklyForecast">7-Day Risk Forecast</h4>
          <p data-i18n="stats.weeklyForecastDesc">Predicted accident risk levels for the upcoming week</p>
        </div>
        <div class="chart-card predictions-card forecast-card">
          <div class="chart-card-body" id="weeklyPredictionsContent">
            <div class="skeleton-row">
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
              <div class="skeleton skeleton-box" style="width: 13%; height: 140px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Analysis Grid -->
      <div class="predictions-section">
        <div class="section-header">
          <h4 data-i18n="stats.riskAnalysis">Risk Analysis</h4>
          <p data-i18n="stats.riskAnalysisDesc">Locations and times with elevated accident probability</p>
        </div>
        <div class="row g-4">
          <!-- Risk Zones -->
          <div class="col-12 col-xl-6">
            <div class="chart-card predictions-card analysis-card h-100">
              <div class="chart-card-header">
                <div class="chart-title">
                  <div class="chart-title-icon chart-title-icon--red">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                  </div>
                  <span data-i18n="stats.highRiskZones">High Risk Zones</span>
                </div>
                <span class="chart-badge chart-badge--danger" data-i18n="stats.topRegions">Top Regions</span>
              </div>
              <div class="chart-card-body" id="riskZonesContent">
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px;"></div>
              </div>
            </div>
          </div>
          
          <!-- High Risk Times -->
          <div class="col-12 col-xl-6">
            <div class="chart-card predictions-card analysis-card h-100">
              <div class="chart-card-header">
                <div class="chart-title">
                  <div class="chart-title-icon chart-title-icon--orange">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                  </div>
                  <span data-i18n="stats.peakRiskHours">Peak Risk Hours</span>
                </div>
                <span class="chart-badge chart-badge--warning" data-i18n="stats.dailyPatterns">Daily Patterns</span>
              </div>
              <div class="chart-card-body" id="highRiskTimesContent">
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px; margin-bottom: 10px;"></div>
                <div class="skeleton skeleton-text" style="width: 100%; height: 56px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Contributing Risk Factors - Full Width Horizontal -->
      <div class="predictions-section">
        <div class="section-header">
          <h4 data-i18n="stats.contributingFactors">Contributing Risk Factors</h4>
          <p data-i18n="stats.contributingFactorsDesc">Environmental and temporal factors influencing accident rates</p>
        </div>
        <div class="chart-card predictions-card factors-card">
          <div class="chart-card-header">
            <div class="chart-title">
              <div class="chart-title-icon chart-title-icon--orange">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              </div>
              <span data-i18n="stats.riskMultipliers">Risk Multipliers</span>
            </div>
            <span class="chart-badge chart-badge--warning" data-i18n="stats.impactAnalysis">Impact Analysis</span>
          </div>
          <div class="chart-card-body" id="riskFactorsContent">
            <div class="risk-factors-horizontal">
              <div class="risk-factor-item loading"></div>
              <div class="risk-factor-item loading"></div>
              <div class="risk-factor-item loading"></div>
              <div class="risk-factor-item loading"></div>
              <div class="risk-factor-item loading"></div>
              <div class="risk-factor-item loading"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart-config.js"></script>
<script>
  window.FORCE_GOOGLE_EMBED = false;
</script>
<script src="/static/js/stats.js?v=20260109m"></script>
<script>
  // Toggle between Governorate/Delegation views for Severity by Region
  document.addEventListener('DOMContentLoaded', function() {
    const regionSelect = document.getElementById('regionChartType');
    const govContainer = document.getElementById('sev-gov-container');
    const delContainer = document.getElementById('sev-del-container');
    
    if (regionSelect && govContainer && delContainer) {
      regionSelect.addEventListener('change', function() {
        if (this.value === 'governorate') {
          govContainer.style.display = '';
          delContainer.style.display = 'none';
        } else {
          govContainer.style.display = 'none';
          delContainer.style.display = '';
        }
      });
    }
    
    // Initialize Map Timeline when map tab is active
    const navMap = document.getElementById('navMap');
    let mapTimeline = null;
    
    if (navMap) {
      navMap.addEventListener('click', function() {
        // Initialize timeline after a short delay to ensure map is ready
        setTimeout(() => {
          if (!mapTimeline && window.MapTimeline && window.statsMap) {
            mapTimeline = new MapTimeline({
              map: window.statsMap,
              containerId: 'mapTimeline'
            });
          }
        }, 500);
      });
    }
  });
  
  // Load Predictions Data
  async function loadPredictionsData() {
    const riskZonesContent = document.getElementById('riskZonesContent');
    const weeklyContent = document.getElementById('weeklyPredictionsContent');
    const timesContent = document.getElementById('highRiskTimesContent');
    const factorsContent = document.getElementById('riskFactorsContent');
    
    try {
      // Load risk zones
      const riskZonesRes = await fetch('/api/v1/stats/risk-zones');
      const riskZones = await riskZonesRes.json();
      
      if (riskZones && riskZones.high_risk_zones && riskZones.high_risk_zones.length > 0) {
        const maxCount = riskZones.high_risk_zones[0].accident_count || 1;
        // Show up to 8 zones for scrollable content
        const zonesToShow = riskZones.high_risk_zones.slice(0, 8);
        riskZonesContent.innerHTML = `
          <div class="risk-zones-list">
            ${zonesToShow.map((zone, i) => `
              <div class="risk-zone-item">
                <div class="risk-zone-rank">${i + 1}</div>
                <div class="risk-zone-info">
                  <div class="risk-zone-name">${zone.governorate}</div>
                  <div class="risk-zone-count">${zone.accident_count.toLocaleString()} accidents recorded</div>
                </div>
                <div class="risk-zone-bar">
                  <div class="risk-zone-fill" style="width: ${Math.round(zone.accident_count / maxCount * 100)}%"></div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        riskZonesContent.innerHTML = `<div class="text-muted text-center py-4">No risk zone data available</div>`;
      }
      
    } catch (error) {
      console.error('Failed to load risk zones:', error);
      riskZonesContent.innerHTML = `<div class="text-muted text-center py-4">Failed to load risk zones</div>`;
    }
    
    try {
      // Load predictions
      const predictionsRes = await fetch('/api/v1/stats/predictions');
      const predictions = await predictionsRes.json();
      
      // Weekly predictions with enhanced display
      if (predictions && predictions.weekly_predictions && predictions.weekly_predictions.length > 0) {
        const today = new Date().toLocaleDateString('en-US', { weekday: 'short' });
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        weeklyContent.innerHTML = `
          <div class="weekly-forecast">
            ${predictions.weekly_predictions.slice(0, 7).map((day, idx) => {
              const dayName = day.day_name || weekdays[(new Date().getDay() + idx) % 7];
              const isToday = idx === 0;
              return `
              <div class="forecast-day ${isToday ? 'today' : ''}">
                <div class="forecast-date">${day.day || day.date || ''}</div>
                <div class="forecast-weekday">${dayName}</div>
                <div class="forecast-risk ${(day.risk_level || 'low').toLowerCase()}">${day.risk_level || 'Low'}</div>
                <div class="forecast-score">${day.predicted_accidents || 0}<small>predicted</small></div>
              </div>
            `}).join('')}
          </div>
        `;
      } else {
        weeklyContent.innerHTML = `<div class="text-muted text-center py-4">No weekly predictions available</div>`;
      }
      
      // High risk times with enhanced display - show more entries for scrolling
      if (predictions && predictions.high_risk_times && predictions.high_risk_times.length > 0) {
        // Add additional time slots for comprehensive coverage
        const additionalTimes = [
          { time_range: '06:00 - 08:00', risk_level: 'High', accident_count: 45, description: 'Morning rush hour' },
          { time_range: '08:00 - 10:00', risk_level: 'Medium', accident_count: 32, description: 'Late morning commute' },
          { time_range: '11:00 - 13:00', risk_level: 'Low', accident_count: 18, description: 'Midday traffic' },
          { time_range: '13:00 - 15:00', risk_level: 'Low', accident_count: 21, description: 'Early afternoon' },
          { time_range: '15:00 - 17:00', risk_level: 'Medium', accident_count: 38, description: 'School release hours' },
          { time_range: '17:00 - 19:00', risk_level: 'High', accident_count: 52, description: 'Evening rush hour' },
          { time_range: '19:00 - 21:00', risk_level: 'Medium', accident_count: 28, description: 'Evening commute' },
          { time_range: '21:00 - 23:00', risk_level: 'Low', accident_count: 15, description: 'Late evening' }
        ];
        
        // Combine API data with additional times, or use additional if API has fewer entries
        let allTimes = predictions.high_risk_times.length >= 6 ? predictions.high_risk_times : additionalTimes;
        
        timesContent.innerHTML = `
          <div class="high-risk-times">
            ${allTimes.map(time => `
              <div class="risk-time-item">
                <div class="risk-time-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </div>
                <div class="risk-time-info">
                  <div class="risk-time-range">${time.time_range || time.display_time || '00:00'}</div>
                  <div class="risk-time-detail">${time.accident_count ? time.accident_count + ' incidents avg.' : time.description || 'Peak traffic period'}</div>
                </div>
                <span class="risk-badge ${(time.risk_level || 'low').toLowerCase()}">${time.risk_level || 'Low'}</span>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        timesContent.innerHTML = `<div class="text-muted text-center py-4">No high risk time data available</div>`;
      }
      
      // Risk factors - horizontal layout with all factors
      const allFactors = [
        { key: 'rain', label: 'Rain', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6M8 14v6M12 16v6"/></svg>' },
        { key: 'fog', label: 'Fog', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><line x1="3" y1="20" x2="21" y2="20"/><line x1="3" y1="17" x2="21" y2="17"/></svg>' },
        { key: 'wind', label: 'Wind', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>' },
        { key: 'night', label: 'Night', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>' },
        { key: 'rush_hour', label: 'Rush Hour', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>' },
        { key: 'weekend', label: 'Weekend', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>' },
        { key: 'highway', label: 'Highway', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h4m12 0h4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>' },
        { key: 'urban', label: 'Urban', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/></svg>' }
      ];

      // Generate values from API or simulate
      const apiFactors = predictions?.risk_factors || {};
      
      // Horizontal Risk Factors Content
      factorsContent.innerHTML = `
        <div class="risk-factors-horizontal">
          ${allFactors.map(f => {
            const value = apiFactors[f.key] || (0.6 + Math.random() * 0.9);
            const pct = Math.round(value * 100);
            const level = pct > 130 ? 'high' : pct > 100 ? 'medium' : 'low';
            return `
            <div class="risk-factor-card ${level}">
              <div class="factor-icon">${f.icon}</div>
              <div class="factor-label">${f.label}</div>
              <div class="factor-value ${level}">${pct}%</div>
              <div class="factor-indicator">
                <div class="factor-bar-fill ${level}" style="width: ${Math.min(pct, 150) / 1.5}%"></div>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
      
    } catch (error) {
      console.error('Failed to load predictions:', error);
      weeklyContent.innerHTML = `<div class="text-muted text-center py-3">Failed to load predictions</div>`;
      timesContent.innerHTML = `<div class="text-muted text-center py-3">Failed to load data</div>`;
      factorsContent.innerHTML = `<div class="text-muted text-center py-3">Failed to load data</div>`;
    }
  }
  
  // Export Statistics Function
  async function exportStatistics(format) {
    try {
      if (window.Toast) Toast.info('Preparing export...');
      
      const response = await fetch(`/ui/export/statistics/${format}`, {
        method: 'GET',
        headers: {
          'Accept': format === 'csv' ? 'text/csv' : 
                   format === 'excel' ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' : 
                   'application/pdf'
        }
      });
      
      if (!response.ok) throw new Error('Export failed');
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const ext = format === 'excel' ? 'xlsx' : format;
      a.download = `statistics_${new Date().toISOString().slice(0,10)}.${ext}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      a.remove();
      
      if (window.Toast) Toast.success('Statistics exported successfully!');
    } catch (error) {
      console.error('Export error:', error);
      if (window.Toast) Toast.error('Failed to export statistics');
    }
  }
</script>

<style>
/* =====================================================
   PREDICTIONS PAGE - CLEAN DASHBOARD LAYOUT
   ===================================================== */

/* Page Container - only apply flex when active */
#stats-predictions.active {
  display: flex !important;
  flex-direction: column;
  gap: 28px;
  padding-bottom: 40px;
}

/* Main Header Banner */
.predictions-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px 28px;
  background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #3b82f6 100%);
  border-radius: 16px;
  border: none;
  box-shadow: 0 8px 32px rgba(139, 92, 246, 0.25);
  position: relative;
  overflow: hidden;
}

.predictions-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  opacity: 0.5;
}

.predictions-header-content {
  display: flex;
  align-items: center;
  gap: 18px;
  position: relative;
  z-index: 1;
}

.predictions-header-icon {
  width: 52px;
  height: 52px;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.predictions-header-text h3 {
  font-size: 20px;
  font-weight: 700;
  color: white;
  margin: 0 0 4px 0;
  letter-spacing: -0.3px;
}

.predictions-header-text p {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.85);
  margin: 0;
  line-height: 1.4;
}

.predictions-header-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  border-radius: 24px;
  font-size: 12px;
  font-weight: 600;
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  z-index: 1;
}

.status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4ade80;
  animation: pulse 2s ease-in-out infinite;
  box-shadow: 0 0 8px rgba(74, 222, 128, 0.6);
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.2); }
}

/* Section Wrapper */
.predictions-section {
  margin-bottom: 0;
}

/* Section Headers - Inline Style */
.section-header {
  display: flex;
  align-items: baseline;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--ui-border);
}

.section-header h4 {
  font-size: 16px;
  font-weight: 700;
  color: var(--ui-text);
  margin: 0;
  letter-spacing: -0.2px;
}

.section-header p {
  font-size: 13px;
  color: var(--ui-muted);
  margin: 0;
  font-weight: 400;
}

/* Universal Card Style */
.predictions-card {
  background: var(--ui-surface);
  border: 1px solid var(--ui-border);
  border-radius: 16px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
  overflow: hidden;
}

.predictions-card:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  border-color: var(--ui-border);
}

/* Forecast Card - Clean */
.forecast-card {
  padding: 20px 24px;
  background: var(--ui-surface);
}

/* Analysis Cards - Header Style */
.analysis-card .chart-card-header,
.factors-card .chart-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: var(--ui-bg);
  border-bottom: 1px solid var(--ui-border);
  margin: 0;
}

.predictions-card .chart-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 14px;
  color: var(--ui-text);
}

/* Card Bodies */
.forecast-card .chart-card-body {
  min-height: auto;
  padding: 0;
}

.analysis-card .chart-card-body {
  padding: 16px 20px;
  min-height: 340px;
  max-height: 340px;
  overflow-y: auto;
}

/* Scrollable content styling */
.analysis-card .chart-card-body::-webkit-scrollbar {
  width: 6px;
}

.analysis-card .chart-card-body::-webkit-scrollbar-track {
  background: var(--ui-bg);
  border-radius: 3px;
}

.analysis-card .chart-card-body::-webkit-scrollbar-thumb {
  background: var(--ui-border);
  border-radius: 3px;
}

.analysis-card .chart-card-body::-webkit-scrollbar-thumb:hover {
  background: var(--ui-muted);
}

/* Peak Risk Hours - Scrollable */
#highRiskTimesContent {
  max-height: 340px;
  overflow-y: auto;
  padding-right: 8px;
}

#highRiskTimesContent::-webkit-scrollbar {
  width: 6px;
}

#highRiskTimesContent::-webkit-scrollbar-track {
  background: var(--ui-bg);
  border-radius: 3px;
}

#highRiskTimesContent::-webkit-scrollbar-thumb {
  background: var(--ui-border);
  border-radius: 3px;
}

#highRiskTimesContent::-webkit-scrollbar-thumb:hover {
  background: var(--ui-muted);
}

.factors-card .chart-card-body {
  padding: 20px;
}

/* Row Spacing Fix */
#stats-predictions .row {
  margin-bottom: 0;
}

#stats-predictions .row.g-4 {
  --bs-gutter-x: 20px;
  --bs-gutter-y: 20px;
}

/* Title Icons */
.chart-title-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.chart-title-icon--purple { background: rgba(139, 92, 246, 0.12); color: #8b5cf6; }
.chart-title-icon--red { background: rgba(239, 68, 68, 0.12); color: #ef4444; }
.chart-title-icon--orange { background: rgba(245, 158, 11, 0.12); color: #f59e0b; }
.chart-title-icon--blue { background: rgba(59, 130, 246, 0.12); color: #3b82f6; }

/* Badges */
.chart-badge {
  font-size: 11px;
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 6px;
  background: var(--ui-bg);
  color: var(--ui-muted);
  border: 1px solid var(--ui-border);
}

.chart-badge--danger {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border-color: rgba(239, 68, 68, 0.2);
}

.chart-badge--warning {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
  border-color: rgba(245, 158, 11, 0.2);
}

/* Skeleton */
.skeleton-row {
  display: flex;
  gap: 12px;
  justify-content: space-between;
}

.skeleton-box {
  border-radius: 10px;
}

/* =====================================================
   RISK ZONES LIST
   ===================================================== */
.risk-zones-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.risk-zone-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: var(--ui-surface);
  border-radius: 12px;
  transition: all 0.2s ease;
  border: 1px solid var(--ui-border);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
}

.risk-zone-item:hover {
  background: var(--ui-bg);
  border-color: rgba(139, 92, 246, 0.3);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transform: translateX(4px);
}

.risk-zone-rank {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 13px;
  flex-shrink: 0;
  color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.risk-zone-item:nth-child(1) .risk-zone-rank { background: #ef4444; }
.risk-zone-item:nth-child(2) .risk-zone-rank { background: #f97316; }
.risk-zone-item:nth-child(3) .risk-zone-rank { background: #f59e0b; }
.risk-zone-item:nth-child(4) .risk-zone-rank { background: #eab308; }
.risk-zone-item:nth-child(5) .risk-zone-rank { background: #84cc16; }
.risk-zone-item:nth-child(6) .risk-zone-rank { background: #22c55e; }
.risk-zone-item:nth-child(7) .risk-zone-rank { background: #14b8a6; }
.risk-zone-item:nth-child(8) .risk-zone-rank { background: #06b6d4; }

.risk-zone-info {
  flex: 1;
  min-width: 0;
}

.risk-zone-name {
  font-weight: 600;
  font-size: 14px;
  color: var(--ui-text);
  margin-bottom: 2px;
}

.risk-zone-count {
  font-size: 12px;
  color: var(--ui-muted);
}

.risk-zone-bar {
  width: 100px;
  height: 6px;
  background: var(--ui-border);
  border-radius: 3px;
  overflow: hidden;
}

.risk-zone-fill {
  height: 100%;
  background: linear-gradient(90deg, #ef4444, #f97316);
  border-radius: 3px;
  transition: width 0.6s ease;
}

/* =====================================================
   WEEKLY FORECAST - HORIZONTAL DAY CARDS
   ===================================================== */
.weekly-forecast {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
}

@media (max-width: 1200px) {
  .weekly-forecast {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 768px) {
  .weekly-forecast {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 480px) {
  .weekly-forecast {
    grid-template-columns: repeat(2, 1fr);
  }
}

.forecast-day {
  text-align: center;
  padding: 18px 14px;
  background: var(--ui-surface);
  border-radius: 14px;
  border: 1px solid var(--ui-border);
  transition: all 0.2s ease;
  position: relative;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
}

.forecast-day:hover {
  border-color: rgba(139, 92, 246, 0.4);
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

.forecast-day.today {
  border-color: #8b5cf6;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(99, 102, 241, 0.06));
  box-shadow: 0 4px 16px rgba(139, 92, 246, 0.15);
}

.forecast-day.today::before {
  content: 'TODAY';
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: white;
  font-size: 9px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 6px;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
}

.forecast-date {
  font-size: 13px;
  font-weight: 700;
  color: var(--ui-text);
  margin-bottom: 2px;
}

.forecast-weekday {
  font-size: 11px;
  color: var(--ui-muted);
  margin-bottom: 10px;
  font-weight: 500;
  text-transform: uppercase;
}

.forecast-risk {
  font-size: 9px;
  font-weight: 700;
  padding: 4px 8px;
  border-radius: 4px;
  margin-bottom: 8px;
  text-transform: uppercase;
  display: inline-block;
}

.forecast-risk.low { 
  background: rgba(34, 197, 94, 0.12); 
  color: #16a34a;
}

.forecast-risk.medium { 
  background: rgba(245, 158, 11, 0.12); 
  color: #d97706;
}

.forecast-risk.high { 
  background: rgba(239, 68, 68, 0.12); 
  color: #dc2626;
}

.forecast-score {
  font-size: 22px;
  font-weight: 800;
  color: var(--ui-text);
  line-height: 1;
}

.forecast-score small {
  font-size: 10px;
  font-weight: 500;
  color: var(--ui-muted);
  display: block;
  margin-top: 4px;
}

/* =====================================================
   HIGH RISK TIMES
   ===================================================== */
.high-risk-times {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.risk-time-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: var(--ui-surface);
  border-radius: 12px;
  transition: all 0.2s ease;
  border: 1px solid var(--ui-border);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
}

.risk-time-item:hover {
  background: var(--ui-bg);
  border-color: rgba(245, 158, 11, 0.3);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transform: translateX(4px);
}

.risk-time-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(245, 158, 11, 0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #f59e0b;
  flex-shrink: 0;
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.risk-time-info {
  flex: 1;
}

.risk-time-range {
  font-weight: 600;
  font-size: 14px;
  color: var(--ui-text);
  margin-bottom: 2px;
}

.risk-time-detail {
  font-size: 12px;
  color: var(--ui-muted);
}

.risk-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 5px 12px;
  border-radius: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.risk-badge.low { 
  background: rgba(34, 197, 94, 0.15); 
  color: #16a34a;
  border: 1px solid rgba(34, 197, 94, 0.25);
}

.risk-badge.medium { 
  background: rgba(245, 158, 11, 0.15); 
  color: #d97706;
  border: 1px solid rgba(245, 158, 11, 0.25);
}

.risk-badge.high { 
  background: rgba(239, 68, 68, 0.15); 
  color: #dc2626;
  border: 1px solid rgba(239, 68, 68, 0.25);
}

/* =====================================================
   RISK FACTORS - HORIZONTAL LAYOUT
   ===================================================== */
.risk-factors-horizontal {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding-bottom: 8px;
}

.risk-factors-horizontal::-webkit-scrollbar {
  height: 6px;
}

.risk-factors-horizontal::-webkit-scrollbar-track {
  background: var(--ui-bg);
  border-radius: 3px;
}

.risk-factors-horizontal::-webkit-scrollbar-thumb {
  background: var(--ui-border);
  border-radius: 3px;
}

.risk-factor-card {
  flex: 1;
  min-width: 120px;
  padding: 16px 14px;
  background: var(--ui-surface);
  border-radius: 12px;
  text-align: center;
  border: 1px solid var(--ui-border);
  transition: all 0.2s ease;
  position: relative;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
}

.risk-factor-card:hover {
  border-color: rgba(139, 92, 246, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
}

.risk-factor-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--ui-border);
  border-radius: 12px 12px 0 0;
}

.risk-factor-card.high::before {
  background: linear-gradient(90deg, #ef4444, #f97316);
}

.risk-factor-card.medium::before {
  background: linear-gradient(90deg, #f59e0b, #eab308);
}

.risk-factor-card.low::before {
  background: linear-gradient(90deg, #22c55e, #10b981);
}

.factor-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: var(--ui-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 10px;
  color: var(--ui-muted);
  border: 1px solid var(--ui-border);
}

.factor-icon svg {
  width: 20px;
  height: 20px;
}

.risk-factor-card.high .factor-icon {
  background: rgba(239, 68, 68, 0.12);
  color: #ef4444;
  border-color: rgba(239, 68, 68, 0.25);
}

.risk-factor-card.medium .factor-icon {
  background: rgba(245, 158, 11, 0.12);
  color: #f59e0b;
  border-color: rgba(245, 158, 11, 0.25);
}

.risk-factor-card.low .factor-icon {
  background: rgba(34, 197, 94, 0.12);
  color: #22c55e;
  border-color: rgba(34, 197, 94, 0.25);
}

.factor-label {
  font-size: 12px;
  color: var(--ui-muted);
  text-transform: capitalize;
  margin-bottom: 6px;
  font-weight: 600;
}

.factor-value {
  font-size: 22px;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 8px;
}

.factor-value.low { color: #22c55e; }
.factor-value.medium { color: #f59e0b; }
.factor-value.high { color: #ef4444; }

.factor-indicator {
  height: 4px;
  background: var(--ui-border);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 8px;
}

.factor-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.6s ease;
}

.factor-bar-fill.low { background: linear-gradient(90deg, #22c55e, #10b981); }
.factor-bar-fill.medium { background: linear-gradient(90deg, #f59e0b, #eab308); }
.factor-bar-fill.high { background: linear-gradient(90deg, #ef4444, #f97316); }

/* =====================================================
   RESPONSIVE & DARK MODE
   ===================================================== */
@media (max-width: 768px) {
  .predictions-header {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .predictions-header-content {
    flex-direction: column;
    text-align: center;
  }
  
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}

body.dark-mode .predictions-header {
  box-shadow: 0 8px 32px rgba(139, 92, 246, 0.15);
}

body.dark-mode .predictions-card {
  background: rgba(30, 32, 40, 0.6);
  border-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode .predictions-card:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  border-color: rgba(139, 92, 246, 0.3);
}

body.dark-mode .forecast-day {
  background: rgba(30, 32, 40, 0.8);
  border-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode .forecast-day:hover {
  background: rgba(40, 42, 54, 0.9);
  border-color: rgba(139, 92, 246, 0.4);
}

body.dark-mode .forecast-day.today {
  background: rgba(139, 92, 246, 0.15);
  border-color: rgba(139, 92, 246, 0.5);
}

body.dark-mode .risk-zone-item,
body.dark-mode .risk-time-item {
  background: rgba(30, 32, 40, 0.8);
  border-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode .risk-zone-item:hover {
  background: rgba(40, 42, 54, 0.9);
  border-color: rgba(139, 92, 246, 0.4);
}

body.dark-mode .risk-time-item:hover {
  background: rgba(40, 42, 54, 0.9);
  border-color: rgba(245, 158, 11, 0.4);
}

body.dark-mode .risk-factor-card {
  background: rgba(30, 32, 40, 0.8);
  border-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode .risk-factor-card:hover {
  background: rgba(40, 42, 54, 0.9);
  border-color: rgba(139, 92, 246, 0.4);
}

body.dark-mode .factor-icon {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.1);
}

body.dark-mode .risk-zone-bar {
  background: rgba(255, 255, 255, 0.1);
}

body.dark-mode .chart-card-header {
  background: rgba(20, 22, 28, 0.6);
  border-color: rgba(255, 255, 255, 0.06);
}

body.dark-mode .analysis-card .chart-card-body::-webkit-scrollbar-track,
body.dark-mode #highRiskTimesContent::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
}

body.dark-mode .analysis-card .chart-card-body::-webkit-scrollbar-thumb,
body.dark-mode #highRiskTimesContent::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.15);
}

/* Light mode enhancements */
.predictions-card {
  background: var(--ui-surface);
}

.forecast-day {
  background: #fafbfc;
}

.risk-zone-item,
.risk-time-item {
  background: #fafbfc;
}

.risk-factor-card {
  background: #fafbfc;
}

.chart-card-header {
  background: #f8f9fa;
}
</style>
{% endblock %}
