{% extends 'base_private.html' %}
{% block content %}
<div class="d-flex justify-content-center align-items-center page-fade" style="min-height: 80vh;">
  <div class="glass-card card-anim" style="max-width: 500px; width: 100%;">
    <h3 class="mb-4 text-center" data-i18n="editAccident.title">Edit Accident #{{ accident.id }}</h3>
    <input type="hidden" id="accident-id" value="{{ accident.id }}">
    <div class="mb-3">
      <label class="form-label" data-i18n="editAccident.date">Date</label>
      <input type="text" id="date" class="form-control" value="{{ accident.date_human if accident.date_human is defined else accident.date }}" readonly>
    </div>
    <div class="mb-3">
      <label class="form-label" data-i18n="editAccident.location">Location</label>
      <input type="text" id="location" class="form-control" value="{{ accident.governorate if accident.governorate is defined else accident.location }}">
    </div>
    <div class="mb-3">
      <label class="form-label" data-i18n="editAccident.delegation">Delegation</label>
      <input type="text" id="delegation" class="form-control" value="{{ accident.delegation }}">
    </div>
    <div class="mb-3">
      <label class="form-label" data-i18n="editAccident.severity">Severity</label>
      <select id="severity" class="form-select">
        <option value="fatal" {% if accident.severity == 'fatal' %}selected{% endif %} data-i18n="accidents.fatal">Fatal</option>
        <option value="serious" {% if accident.severity == 'serious' %}selected{% endif %} data-i18n="accidents.serious">Serious</option>
        <option value="minor" {% if accident.severity == 'minor' %}selected{% endif %} data-i18n="accidents.minor">Minor</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label" data-i18n="editAccident.cause">Cause</label>
      <input type="text" id="cause" class="form-control" value="{{ accident.cause }}">
    </div>
    <div id="form-status" class="mb-2" style="min-height:1.5em;"></div>
    <div class="d-flex justify-content-center gap-2">
      <button id="save-accident-btn" type="button" class="btn btn-primary">Save</button>
      <a href="{{ url_for('accidents_ui.accident_detail', accident_id=accident.id) }}" class="btn btn-outline-secondary" data-i18n="common.cancel">Cancel</a>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("save-accident-btn");
  const statusDiv = document.getElementById('form-status');
  btn.addEventListener("click", async () => {
    const accidentId = document.getElementById('accident-id').value;
    console.log("UPDATE CLICKED, ID =", accidentId);
    if (!accidentId || isNaN(accidentId)) {
      alert("Invalid accident ID");
      return;
    }
    // Collect form data
    const payload = {
      location: document.getElementById('location').value,
      delegation: document.getElementById('delegation').value,
      severity: document.getElementById('severity').value,
      cause: document.getElementById('cause').value
    };
    try {
      const res = await fetch(`/api/v1/accidents/${accidentId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        alert(data.error || "Update failed");
        return;
      }
      alert("Accident updated successfully");
      window.location.href = "{{ url_for('accidents_ui.accident_detail', accident_id=accident.id) }}";
    } catch (e) {
      alert("Network error");
    }
  });
});
</script>
{% endblock %}
